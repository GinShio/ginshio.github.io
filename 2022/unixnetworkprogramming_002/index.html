<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>传输层总述 - iris</title><meta name="Description" content="GinShio | Unix 网络编程：卷一 (3rd) 第一部分第二章：传输层协议 (TCP，UDP，SCTP)"><meta property="og:title" content="传输层总述" />
<meta property="og:description" content="GinShio | Unix 网络编程：卷一 (3rd) 第一部分第二章：传输层协议 (TCP，UDP，SCTP)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" /><meta property="og:image" content="https://blog.ginshio.org/avatar.webp"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-18T19:55:40+08:00" />
<meta property="article:modified_time" content="2022-04-07T19:44:38+08:00" /><meta property="og:site_name" content="iris | GinShio的个人博客" />
<meta property="og:see_also" content="https://blog.ginshio.org/2022/unixnetworkprogramming_001/" /><meta property="og:see_also" content="https://blog.ginshio.org/2022/unixnetworkprogramming_003/" /><meta property="og:see_also" content="https://blog.ginshio.org/2022/unixnetworkprogramming_004/" /><meta property="og:see_also" content="https://blog.ginshio.org/2022/unixnetworkprogramming_005/" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.ginshio.org/avatar.webp"/>

<meta name="twitter:title" content="传输层总述"/>
<meta name="twitter:description" content="GinShio | Unix 网络编程：卷一 (3rd) 第一部分第二章：传输层协议 (TCP，UDP，SCTP)"/>
<meta name="application-name" content="iris">
<meta name="apple-mobile-web-app-title" content="iris">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" /><link rel="prev" href="https://blog.ginshio.org/2022/unixnetworkprogramming_001/" /><link rel="next" href="https://blog.ginshio.org/2022/dst_lua_language_study/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.1d6e6517c44074bf1c692657d249d106a5e98bb9db25f7773715b24eda7aa575354611c095c23092aa17916f1b5be527.css" integrity="sha384-HW5lF8RAdL8caSZX0knRBqXpi7nbJfd3NxWyTtp6pXU1RhHAlcIwkqoXkW8bW&#43;Un"><link rel="stylesheet" href="/css/style.min.cd14de6b7577483a378a3e7b1d8d4d22e9116704e99988548443184415b6e7ea3d5f86d181e92e8d979297f4dc91299a.css" integrity="sha384-zRTea3V3SDo3ij57HY1NIukRZwTpmYhUhEMYRBW25&#43;o9X4bRgekujZeSl/TckSma"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.2cba216129d7b04299cad0e4a8bb0eb317de61d6e2489778de53950bfcb59fa58d01a258c9e2675ffa3c07c058996f2d.css" integrity="sha384-LLohYSnXsEKZytDkqLsOsxfeYdbiSJd43lOVC/y1n6WNAaJYyeJnX/o8B8BYmW8t">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.2cba216129d7b04299cad0e4a8bb0eb317de61d6e2489778de53950bfcb59fa58d01a258c9e2675ffa3c07c058996f2d.css" integrity="sha384-LLohYSnXsEKZytDkqLsOsxfeYdbiSJd43lOVC/y1n6WNAaJYyeJnX/o8B8BYmW8t"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.1aedca555d87f5dfb2038403a5507b55c3b284994056b717774b61123af82b39df6853cb7b4c50272a2757138d6b8642.css" integrity="sha384-Gu3KVV2H9d&#43;yA4QDpVB7VcOyhJlAVrcXd0thEjr4KznfaFPLe0xQJyonVxONa4ZC">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.1aedca555d87f5dfb2038403a5507b55c3b284994056b717774b61123af82b39df6853cb7b4c50272a2757138d6b8642.css" integrity="sha384-Gu3KVV2H9d&#43;yA4QDpVB7VcOyhJlAVrcXd0thEjr4KznfaFPLe0xQJyonVxONa4ZC"></noscript>
    
    
    
    <meta name="google-site-verification" content="fbzw9fQcZyEFrrrUtxLfzYW-qhZ5TMEZKHHSp9NeLBw" /><meta name="msvalidate.01" content="EC9CEC799D42793C414AE7BDB0D0205C" /><meta name="yandex-verification" content="c0b808dd3e49f730" /><meta name="baidu-site-verification" content="code-RhPhu2ccLc" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "传输层总述",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.ginshio.org\/2022\/unixnetworkprogramming_002\/"
        },"image": ["https:\/\/blog.ginshio.org\/screenshot.png"],"genre": "posts","keywords": "Note, Unix, Network, Posix","wordcount":  7539 ,
        "url": "https:\/\/blog.ginshio.org\/2022\/unixnetworkprogramming_002\/","datePublished": "2022-01-18T19:55:40+08:00","dateModified": "2022-04-07T19:44:38+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "GinShio","logo": "https:\/\/blog.ginshio.org\/avatar.webp"},"authors": [{
                        "@type": "Person",
                        "name": "GinShio"                    
                    }],"description": "GinShio | Unix 网络编程：卷一 (3rd) 第一部分第二章：传输层协议 (TCP，UDP，SCTP)"
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark' || 'light' === 'black') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="iris"><span class="header-title-pre"><i class="fas fa-terminal"></i></span>iris</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"><i class="fa fa-archive faa-wrench"></i> 归档 </a><a class="menu-item" href="/tags/"><i class="fa fa-tag faa-wrench"></i> 标签 </a><a class="menu-item" href="/categories/"><i class="fa fa-folder-open faa-wrench"></i> 分类 </a><a class="menu-item" href="/series/"><i class="fas fa-object-group"></i> 系列 </a><a class="menu-item" href="/about/"><i class="fa fa-info-circle faa-wrench"></i> 关于 </a><a class="menu-item" href="/links/"><i class="fa fa-user-friends faa-wrench"></i> 友人帐 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="iris"><span class="header-title-pre"><i class="fas fa-terminal"></i></span>iris</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title=""><i class="fa fa-archive faa-wrench"></i>归档</a><a class="menu-item" href="/tags/" title=""><i class="fa fa-tag faa-wrench"></i>标签</a><a class="menu-item" href="/categories/" title=""><i class="fa fa-folder-open faa-wrench"></i>分类</a><a class="menu-item" href="/series/" title=""><i class="fas fa-object-group"></i>系列</a><a class="menu-item" href="/about/" title=""><i class="fa fa-info-circle faa-wrench"></i>关于</a><a class="menu-item" href="/links/" title=""><i class="fa fa-user-friends faa-wrench"></i>友人帐</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#总图">总图</a></li>
    <li><a href="#端口">端口</a></li>
    <li><a href="#缓冲区大小及限制">缓冲区大小及限制</a>
      <ul>
        <li><a href="#tcp-输出">TCP 输出</a></li>
        <li><a href="#udp-输出">UDP 输出</a></li>
        <li><a href="#sctp-输出">SCTP 输出</a></li>
      </ul>
    </li>
    <li><a href="#标准-internet-服务与命令行程序">标准 Internet 服务与命令行程序</a>
      <ul>
        <li><a href="#标准-internet-服务">标准 Internet 服务</a></li>
        <li><a href="#常见命令行程序">常见命令行程序</a></li>
      </ul>
    </li>
    <li><a href="#tcp-连接">TCP 连接</a>
      <ul>
        <li><a href="#tcp-创建连接">TCP 创建连接</a></li>
        <li><a href="#tcp-选项">TCP 选项</a></li>
        <li><a href="#tcp-连接终止">TCP 连接终止</a></li>
        <li><a href="#tcp-状态转换">TCP 状态转换</a></li>
        <li><a href="#tcp-的分节">TCP 的分节</a></li>
        <li><a href="#time-wait-状态">TIME_WAIT 状态</a></li>
      </ul>
    </li>
    <li><a href="#sctp-关联">SCTP 关联</a>
      <ul>
        <li><a href="#sctp-创建关联">SCTP 创建关联</a></li>
        <li><a href="#sctp-终止关联">SCTP 终止关联</a></li>
        <li><a href="#sctp-的分节">SCTP 的分节</a></li>
        <li><a href="#sctp-的选项">SCTP 的选项</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">传输层总述</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><i class="author fas fa-user-circle fa-fw"></i><span class='screen-reader-text'>  </span><a href='https://blog.ginshio.org/authors/ginshio'>GinShio</a></span>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/api/"><i class="far fa-folder fa-fw"></i>API</a></span>&nbsp;<span class="post-category">和</span>&nbsp;<span class="post-series">系列 <a href="/series/unp-note/"><i class="far fa-list-alt fa-fw"></i>UNP Note</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="01-18">01-18</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="04-07">04-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7539 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 16 分钟&nbsp;</div>
        </div><div class="details series-nav open">
                                <div class="details-summary series-title">
                                    <span>系列 - UNP Note</span>
                                    <span><i class="details-icon fas fa-angle-right"></i></span>
                                </div>
                                <div class="details-content series-content">
                                    <nav>
                                        <ul>
                                                    <li><a href="/2022/unixnetworkprogramming_001/">UNP 简介</a></li><li><span class="active">传输层总述</span></li>
                                                    <li><a href="/2022/unixnetworkprogramming_003/">Unix 套接字 API</a></li>
                                                    <li><a href="/2022/unixnetworkprogramming_004/">基本 TCP 编程</a></li>
                                                    <li><a href="/2022/unixnetworkprogramming_005/">I/O 复用</a></li></ul>
                                    </nav>
                                </div>
                            </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#总图">总图</a></li>
    <li><a href="#端口">端口</a></li>
    <li><a href="#缓冲区大小及限制">缓冲区大小及限制</a>
      <ul>
        <li><a href="#tcp-输出">TCP 输出</a></li>
        <li><a href="#udp-输出">UDP 输出</a></li>
        <li><a href="#sctp-输出">SCTP 输出</a></li>
      </ul>
    </li>
    <li><a href="#标准-internet-服务与命令行程序">标准 Internet 服务与命令行程序</a>
      <ul>
        <li><a href="#标准-internet-服务">标准 Internet 服务</a></li>
        <li><a href="#常见命令行程序">常见命令行程序</a></li>
      </ul>
    </li>
    <li><a href="#tcp-连接">TCP 连接</a>
      <ul>
        <li><a href="#tcp-创建连接">TCP 创建连接</a></li>
        <li><a href="#tcp-选项">TCP 选项</a></li>
        <li><a href="#tcp-连接终止">TCP 连接终止</a></li>
        <li><a href="#tcp-状态转换">TCP 状态转换</a></li>
        <li><a href="#tcp-的分节">TCP 的分节</a></li>
        <li><a href="#time-wait-状态">TIME_WAIT 状态</a></li>
      </ul>
    </li>
    <li><a href="#sctp-关联">SCTP 关联</a>
      <ul>
        <li><a href="#sctp-创建关联">SCTP 创建关联</a></li>
        <li><a href="#sctp-终止关联">SCTP 终止关联</a></li>
        <li><a href="#sctp-的分节">SCTP 的分节</a></li>
        <li><a href="#sctp-的选项">SCTP 的选项</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>在传输层中，主要学习三种协议</p>
<ul>
<li>User Datagram Protocol (UDP, 用户数据报协议) 是一种简单 (simple)、不可靠
(unreliable) 的数据报协议</li>
<li>Transmission Control Protocol (TCP, 传输控制协议) 是一种复杂的
(sophisticated)、可靠的 (reliable)、字节流协议</li>
<li>Stream Control Transmission Protocol (SCTP, 流控制传输协议) 是一种较新的、可靠的协议，但它还提供消息边界 (message boundaries)、传输层级别的多宿
(multihoming)、最小化头端阻塞 (head-of-line blocking)</li>
</ul>
<h2 id="总图" class="headerLink">
    <a href="#%e6%80%bb%e5%9b%be" class="header-mark"></a>总图</h2><figure><img src="/images/unp-transport-layer-big-picture.svg" width="90%"/>
</figure>

<p>图中最左边的应用 tcpdump 直接使用数据链路层接口 BPF (BSD packet filter, BSD 分组过滤器) 或 Datalink provider interface (DLPI, 数据链路提供者接口) 进行通信。而其他应用都是用 API 所提供的 socket 或 XTI。当然在 Linux 上提供了 <code>SOCK_PACKET</code> 这种 socket 来访问数据链路。</p>
<dl>
<dt>IPv4</dt>
<dd>Internet Protocol (IP, 网际协议)，版本 4。
<p>这是自 1980 年代早期以来网际协议族中的主力协议，使用 32 bit 编码地址，为 TCP、
UDP、SCTP、ICMP 和 IGMP 提供分组传递服务。</p>
</dd>
<dt>IPv6</dt>
<dd>Internet Protocol, Version 6
<p>1990 年代中期作为 IPv4 的替代版而设计，将 32 bit 扩展到了 128 bit 来应对互联网的爆炸性增长，为 TCP、UDP、SCTP、ICMPv6 提供分组传递服务。</p>
</dd>
<dt>TCP</dt>
<dd>Transmission Control Protocol
<p>TCP 是一种面向连接的协议，提供可靠、全双工的字节流服务，是一种流式 socket，定义在 <strong>RFC 793</strong>, <strong>RFC 1323</strong>, <strong>RFC 2581</strong>, <strong>RFC 2988</strong> 和 <strong>RFC 3390</strong>。</p>
<p>为对端发送消息时必须收到明确的答复，如果没有收到答复 TCP 将自动重发数据并等待一段时间。在尝试多次重传失败时 (大概会在 4 到 10 分钟)，TCP 会主动放弃。主要注意的是 TCP 并不会保证对端接收数据，如果可以 TCP 会尝试重传并通知用户。然而 TCP 不是 \(100\%\) 可靠的协议，它的可靠只是在传送数据或失败时通知。</p>
<p>TCP 包含一个在客户端与服务器之间动态评估 RTT (Round-trip time, 往返时间) 的算法，因此知道一个确认等待了多长时间。举个例子，在穿过 LAN 时可能花费几微秒，而穿过 WAN 时则可能话费数秒。此外，TCP 还会持续评估给定连接的 RTT，因为 RTT
受到网络波动的变化很大。</p>
<p>TCP 会将数据序列在发送时按连续的序号关联。比如一个 4096 字节的数据可能被分节为 3 节 (每节最大 1500 字节)，这三节将会有一个连续的序号作为标记，TCP 将会按顺序发送这三节数据。如果这些数据没有按顺序到达，TCP 将会重新按顺序排序并转发给接收应用。如果 TCP 接收到了重复的数据，它会自动丢弃重复数据 (可能一个数据过于拥堵而非真正丢失，导致发送端重传数据，从而出现重复数据)。</p>
<p>TCP 提供了流量控制，即为对端明确现在有多少字节的数据可以被接收。这又被称为 *
通知窗口* (advertised window)。在任何时刻这些窗口都代表此时缓冲区所能接收的可用大小，以防止溢出。当然这些窗口数量是可以动态变化的，在接收数据时窗口大小减少，从缓冲区读取数据时窗口大小将增大。</p>
</dd>
<dt>UDP</dt>
<dd>User Datagram Protocol
<p>UDP 是一种无连接的协议，是一种数据报 socket，定义在 <strong>RFC 768</strong> 。不保证数据可以到达目的地，也不保证数据按顺序到达，或者数据只会到达一次。如果数据报到达目的地址但校验和发生错误，或者丢失在网络中，它无法投递到 socket，也不会被源端自动重传。如果想要数据可以安全到达目的地址，需要增加很多的特性：对端确认、本端超时与重传。每个 UDP 数据报都有一个长度，这个长度会随数据一起发送给对端。</p>
<p>UDP 往往在服务器与客户端之间搭建短连接，可以使得客户端在发送完数据后，立即向其他服务器发送其他数据。</p>
</dd>
<dt>SCTP</dt>
<dd>Stream Control Transmission Protocol
<p>SCTP 是一种面向连接的服务，且提供了可靠的、全双工关联以及流量控制，定义在
<strong>RFC 2960</strong>, <strong>RFC 3309</strong> 和 <strong>RFC 3286</strong> 中。是 <code>关联</code> 而非连接，因为往往连接表示仅有两个 IP 在通。信</p>
<p>与 TCP 不同的是，SCTP 是面向消息的，可以按序将不同长度的消息分别发送给对端。在两个端点的连接上可以存在多个流，每一个流分别提供可靠的消息分发，每个流相互独立不会因消息丢失而阻塞其他流。相反 TCP 连接上，丢失消息意味着阻塞该连接。</p>
<p>另外 SCTP 还提供了 <strong>多宿</strong> (multihoming) 这种功能，允许单一 SCTP 端点支持多个
IP 地址。这一特性可以增强健壮性来抵抗网络故障。一个端点可以有多个冗余的网络连接，这些网络连接可能来自不同的网络设施，当关联中发生网络故障时 SCTP 可以自动切换到可用的网络设施。</p>
</dd>
<dt>ICMP</dt>
<dd>Internet Control Message Protocol (网际控制消息协议)
<p>ICMP 处理在路由器与主机之间流通的错误与控制消息。这些消息通常由 TCP/IP 网络软件自身产生和处理 (不是用户程序)，但图中的 ping 与 traceroute 也使用这个协议。</p>
</dd>
<dt>IGMP</dt>
<dd>Internet Group Management Protocol (网际组管理协议)
<p>IGMP 主要用于多播。</p>
</dd>
<dt>ARP</dt>
<dd>Address Resolution Protocol (地址解析协议)
<p>ARP 将一个 IPv4 地址解析为一个硬件地址 (如以太网地址)，通常用于以太网、令牌环网和 FDDI 等广播网络，而在 P2P 网络中不需要此协议。</p>
</dd>
<dt>RARP</dt>
<dd>Reverse Address Resolution Protocol (逆地址解析协议)
<p>RARP 作用与 ARP 相反，将一个硬件地址解析为 IPv4 地址，不过有时也将其用于无盘结点的引导。</p>
</dd>
<dt>ICMPv6</dt>
<dd>Internet Control Message Protocol, Version 6
<p>ICMPv6 用于 IPv6 环境，综合了 ICMPv4、IGMP 以及 ARP 的功能。</p>
</dd>
<dt>BPF</dt>
<dd>BSD packet filter (BSD 分组过滤器)
<p>这是一个通常在 BSD 内核中可以找到的功能，提供了直接对数据链路层的访问能力。</p>
</dd>
<dt>DLPI</dt>
<dd>Datalink Provider Interface (数据链路提供者接口)
<p>这是一个通常在 SVR4 内核中可以找到的功能，提供了直接对数据链路层的访问能力。</p>
</dd>
</dl>
<h2 id="端口" class="headerLink">
    <a href="#%e7%ab%af%e5%8f%a3" class="header-mark"></a>端口</h2><p>TCP、UDP 以及 SCTP 都使用 16 bit 端口号来区分不同进程，而客户端想要与服务器联系时，需要标识服务器。</p>
<p>TCP、UDP 以及 SCTP 定义了一组 <strong>公共端口</strong> (well-known port)，用于标识众所周知的服务，比如 FTP 使用 TCP 21 号端口，而 TFTP 使用 UDP 69 号。另一方面用户可能会使用一些短期存活的 <strong>临时端口</strong> (ephemeral port)，这些端口通常由传输层协议自动分配给用户唯一的端口，用户不需要知道其具体值。</p>
<p>IANA (the Internet Assigned Numbers Authority, 互联网号码分配局) 维护着端口号分配状态清单。</p>
<ol>
<li>公共端口为 \(0\) 到 \(1023\) ，这些端口由 IANA 分配和控制，可能的话 TCP、UDP 和
SCTP 将会在同一服务获得相同的端口号，比如无论 TCP 还是 UDP 80 端口都是 Web
服务器，虽然所有实现都是只使用 TCP。</li>
<li>注册端口 (registered port) 为 \(1024\) 到 \(49151\)，这些端口不受 IANA 控制，但 IANA 登记并提供其使用情况清单，方便整个群体。同样地，尽可能将所有协议的同端口号分得同一服务。</li>
<li>动态端口 (dynamic) 或私有端口 (private) 范围为 \(49152\) 到 \(65535\) (这个数是
65536 的 \(\frac{3}{4}\))，即临时端口，这部分是 IANA 不管的。</li>
</ol>
<figure><img src="/images/unp-allocation-of-port-numbers.svg" width="90%"/>
</figure>

<p>上图是不同实现中的端口划分方式，有一些我们需要注意的地方。</p>
<ol>
<li>Unix 系统有着 <strong>保留端口</strong> (reserved port) 的概念，这些端口小于 1024。这些端口号仅可以由特权程序使用。</li>
<li>由于历史原因，BSD 实现 (4.3BSD 开始) 以 1024 到 5000 为临时端口，因为当年支持 3977 个连接的主机相当不容易。如今很多系统实现直接采用 IANA 定义的临时端口，或像 Solaris 一样定义更大的端口。</li>
<li>一些少数的客户端需要保留一个端口用于认证 (例如 rlogin 和 rsh)，这些客户端使用 <code>rresvport</code> 创建 TCP 套接字，并在 513 到 1023 范围内尝试绑定端口 (从
1023 逆序开始)。</li>
</ol>
<h2 id="缓冲区大小及限制" class="headerLink">
    <a href="#%e7%bc%93%e5%86%b2%e5%8c%ba%e5%a4%a7%e5%b0%8f%e5%8f%8a%e9%99%90%e5%88%b6" class="header-mark"></a>缓冲区大小及限制</h2><p>IP 数据报的大小会有一些限制。</p>
<ul>
<li>IPv4 数据报最大大小为 65535 字节 (包含 IPv4 头部)，其长度字段占 16 bit。</li>
<li>IPv6 数据报最大大小为 65575 字节 (包含 40 字节的 IPv6 头部)，其长度字段为数据长度，占 16 bit。</li>
<li>绝大多数网络有一个硬件规定的 MTU (以太网为 1500 byte)，或人为配置的 MTU
(PPP)，IPv4 要求最小 MTU 为 68 字节，这将允许 IPv4 首部 (20 byte 固定长度与
40 byte 选项部分) 拼接最小的片段 (片段偏移字段以 8 byte 为单位)。而 IPv6 要求最小链路 MTU 为 1280 byte。</li>
<li>两主机之间路径中的最小 MTU 称为 <strong>路径 MTU</strong> (path MTU)，1500 byte 的以太网
MTU 是最常用的 path MTU。如果相反两个方向上的 path MTU 不一致被称为不对称的。</li>
<li>IP 数据报从接口送出时，如果大小超过相应链路的 MTU，将执行 <strong>分片</strong>
(fragmentation)，但在到达目的地址时通常不会 <strong>重组</strong> (reassembling)。IPv4 主机对其产生的数据报执行分片，IPv4 路由对其转发的数据报执行分片。在 IPv6 协议栈中只有主机对其产生的数据报进行分片。</li>
<li>IPv4 首部如果设置了 <strong>不分片</strong> (don&rsquo;t fragment, DF)，无论是发送还是转发都不会将其分片。如果路由器收到了一个大小超过链路 MTU 且设置 DF 的数据报时，将产生一个 ICMPv4 <code>destination unreachable fragmentation needed but DF bit set</code>
(目的地不可达，需分片但设置 DF) 的出错消息。同样的 IPv6 可以认为有一个隐含的
DF，当超过链路 MTU 时被路由转发将会出现 ICMPv6 <code>packet too big</code> 的错误消息。</li>
<li>IPv4 和 IPv6 都定义了 <strong>最小重组缓冲区大小</strong> (minimum reassembly buffer size)，它是 IPv4 (576 byte) 或 IPv6 (1500 byte) 的任何实现都必须支持的最小数据报大小。比如 IPv4 数据报我们不能保证目的地址可以接受 577 byte 字节的数据报。</li>
<li>TCP 有一个 MSS (maximum segment size, 最大分节大小) 用于通告对端在每个分节所能发送的最大 TCP 数据量。MSS 的目的是告诉对端其重组缓冲区大小的实际值，从而试图避免分片。MSS 经常被设置为 MTU 减去 IP 和 TCP 首部的固定长度，比如以太网中的 IPv4 MSS 为 1460，IPv6 MSS 为 1440。</li>
<li>SCTP 基于到对端所有地址发现的最小 path MTU 来确定一个分片大小。</li>
</ul>
<h3 id="tcp-输出" class="headerLink">
    <a href="#tcp-%e8%be%93%e5%87%ba" class="header-mark"></a>TCP 输出</h3><figure><img src="/images/unp-steps-and-buffers-involved-in-tcp-socket.svg" width="70%"/>
</figure>

<p>每一个 TCP socket 有一个发送缓冲区，可以使用 SO_SNDBUF 选项来更改该缓冲区的大小。当进程调用 <code>write/3</code> 时，内核从该进程的缓冲区中复制所有数据到 write socket 的发送缓冲区，若发送缓冲区大小不足时将阻塞进程，内核不会从 write 返回，直到所有数据都复制到 socket buffer，因此当 write 返回时仅表示可以使用 buffer 而非对端接收到数据。</p>
<p>本端 TCP 提取 socket buffer 并以 TCP 数据传送规则将其发送，对端 TCP 必须确认收到的数据，对端 ACK 的到来才能在缓冲区中丢弃已确认的数据。另外 TCP 还会为已发送的数据保留副本，直到被对端确认为止。</p>
<p>本端 TCP 以 MSS 大小或更小的 chunk 将数据传送给 IP，同时每个 chunk 上都有 TCP 首部。IP 给每个 TCP 分节按上 IP 首部构成 IP 数据报，查找路由表项确定外出接口，并传递给数据链路层。而虽然数据报可能被 IP 分片，但 MSS 的作用就是尽可能防止分片。</p>
<h3 id="udp-输出" class="headerLink">
    <a href="#udp-%e8%be%93%e5%87%ba" class="header-mark"></a>UDP 输出</h3><figure><img src="/images/unp-steps-and-buffers-involved-in-udp-socket.svg" width="70%"/>
</figure>

<p>上图中的 socket buffer 很明显与 TCP 的区别是虚线表示，实际上这是并不真实存在的
buffer， <code>SO_SNDBUF</code> 的作用是更改可写入 socket 的大小上限。如果应用写一个大于上限的数据报，内核将返回 <strong>EMSGSIZE</strong> 错误。由于 UDP 并不可靠，因此无需额外的 buffer
来备份数据，而是简单的按上 8 byte UDP 首部后传递给 IP 层，在数据被发送后将丢弃数据拷贝。</p>
<p>write 调用成功返回表示 <strong>所写的数据报或其所有分片已被添加至数据链路层的输出队列</strong>
，如果队列没有足够的空间存放该数据报或某个分片时，内核通常返回一个 ENOBUFS 的错误。但是某些实现中将会直接丢弃而不返回错误。</p>
<h3 id="sctp-输出" class="headerLink">
    <a href="#sctp-%e8%be%93%e5%87%ba" class="header-mark"></a>SCTP 输出</h3><figure><img src="/images/unp-steps-and-buffers-involved-in-sctp-socket.svg" width="70%"/>
</figure>

<p>SCTP 与 TCP 类似，因此也需要发送缓冲区，SO_SNDBUF 选项可以更改缓冲区的大小。当调用 write 时，内核从该c進行的缓冲区复制所有数据到 socket buffer。同样的当 socket
buffer 容量不足时将会阻塞进程，直至所有数据被拷贝到 socket buffer。SCTP 必须等待
SACK，确认或累计超出超时重发后才会将数据从 socket buffer 中删除。</p>
<h2 id="标准-internet-服务与命令行程序" class="headerLink">
    <a href="#%e6%a0%87%e5%87%86-internet-%e6%9c%8d%e5%8a%a1%e4%b8%8e%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%a8%8b%e5%ba%8f" class="header-mark"></a>标准 Internet 服务与命令行程序</h2><h3 id="标准-internet-服务" class="headerLink">
    <a href="#%e6%a0%87%e5%87%86-internet-%e6%9c%8d%e5%8a%a1" class="header-mark"></a>标准 Internet 服务</h3><p>TCP/IP 多数实现中都会提供若干标准服务。一般来说无论 TCP 还是 UDP 它们的端口号都相同。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>TCP 端口</th>
<th>UDP 端口</th>
<th>RFC</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>echo</td>
<td>7</td>
<td>7</td>
<td>862</td>
<td>返回客户端发送的数据</td>
</tr>
<tr>
<td>discard</td>
<td>9</td>
<td>9</td>
<td>863</td>
<td>丢弃客户端发送的数据</td>
</tr>
<tr>
<td>daytime</td>
<td>13</td>
<td>13</td>
<td>867</td>
<td>返回可读的时间与日期</td>
</tr>
<tr>
<td>chargen</td>
<td>19</td>
<td>19</td>
<td>864</td>
<td>发送连续的字符流，UDP 则每次发送随机大小的数据报</td>
</tr>
<tr>
<td>time</td>
<td>37</td>
<td>37</td>
<td>868</td>
<td>自 <code>1900.01.01 00:00:00</code> 以来的秒数</td>
</tr>
</tbody>
</table>
<p>这些服务通常由 inetd 守护进程提供，且使用 telnet 客户程序就能完成简易测试。不过由于安全性问题，默认将关闭这些服务。</p>
<h3 id="常见命令行程序" class="headerLink">
    <a href="#%e5%b8%b8%e8%a7%81%e5%91%bd%e4%bb%a4%e8%a1%8c%e7%a8%8b%e5%ba%8f" class="header-mark"></a>常见命令行程序</h3><table>
<thead>
<tr>
<th>应用</th>
<th>IP</th>
<th>ICMP</th>
<th>UDP</th>
<th>TCP</th>
<th>SCTP</th>
</tr>
</thead>
<tbody>
<tr>
<td>ping</td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>traceroute</td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OSPF (路由协议)</td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>RIP (路由协议)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BGP (路由协议)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>BOOTP (引导协议)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>DHCP (引导协议)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>NTP (时间协议)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TFTP (低级 FTP)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SNMP (网络管理)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SMTP (电子邮件)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>Telnet (远程登陆)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>SSH (安全远程登陆)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>FTP (文件传输)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>HTTP (Web)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>NNTP (网络新闻)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>LPR (远程打印)</td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>DNS (域名系统)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>NFS (网络文件系统)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>Sun RPC (远程过程调用)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>DCE RPC (远程过程调用)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td></td>
</tr>
<tr>
<td>IUA (ISDN over IP)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
</tr>
<tr>
<td>M2UA/M3UA (SS7 电话信令)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
</tr>
<tr>
<td>H.248 (媒体网关控制)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
</tr>
<tr>
<td>H.323 (IP 电话)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
</tr>
<tr>
<td>SIP (IP 电话)</td>
<td></td>
<td></td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
<td>\(\checkmark\)</td>
</tr>
</tbody>
</table>
<h2 id="tcp-连接" class="headerLink">
    <a href="#tcp-%e8%bf%9e%e6%8e%a5" class="header-mark"></a>TCP 连接</h2><p>我们需要搞清楚 <code>connect/3</code>, <code>accept/4</code> 和 <code>close/1</code> 这些函数在操作 TCP 连接时都干了什么，因此我们需要学习 TCP 连接的相关内容，比如建立连接、断开连接、以及状态。</p>
<h3 id="tcp-创建连接" class="headerLink">
    <a href="#tcp-%e5%88%9b%e5%bb%ba%e8%bf%9e%e6%8e%a5" class="header-mark"></a>TCP 创建连接</h3><p>在 TCP 连接创建时往往经历以下几个阶段：</p>
<ol>
<li>服务端接受发起的连接，这通常需要 <code>socket/3</code>, <code>bind/3</code>, <code>listen/2</code> 等
API，将其称为 <strong>被动打开</strong> (passive open)</li>
<li>客户端通过 <code>connect/3</code> 进行 <strong>主动打开</strong> (active open)，首先发送 SYN
(synchronize) 字段来告知在这个连接中发送数据的初始序号。通常 SYN 不带数据，仅包含 IP 头、TCP 头以及可选的 TCP选项。</li>
<li>服务器必须为客户端发送的 SYN 回复 ACK (acknowledge)，并发送 SYN 来初始化本端的数据初始序号。ACK 和 SYN 将会合并在一个 TCP 数据中发送。</li>
<li>客户端必须以 ACK 回应服务器的 SYN</li>
</ol>
<figure><img src="/images/unp-tcp-three-way-handshake.svg" width="50%"/>
</figure>

<p>在 TCP 通信中，每个 ACK 都是本端所期待的下一个序列号，SYN 占据一个字节的序列号空间，每个 SYN 中的 ACK 确认号都是 SYN 的序列号加 1。</p>
<h3 id="tcp-选项" class="headerLink">
    <a href="#tcp-%e9%80%89%e9%a1%b9" class="header-mark"></a>TCP 选项</h3><p>每一个 SYN 可以包含一些 TCP 选项，通常常用选项有以下几种：</p>
<ul>
<li>MSS 选项。发送 SYN 的 TCP 端将会告知 <strong>最大分节大小</strong> (maximum segment size,
MSS)，这是本次连接中每个分节所能接受的最大大小，而对端使用该 MSS 值作为分节依据。</li>
<li>窗口扩展选项。TCP 任何一端可以告知对端本次连接最大窗口为 65535 (首部相应字段占 16 bit)，不过当今互联网的高速网络 (大于 45 Mbps) 或长延迟路径 (卫星链路)
可能要求更大的窗口来提高吞吐量。该选项可以指定首部中通知窗口扩大的位数 (左移,
0 到 14 bit)，由此所能提供的最大窗口即 \(65535 \times 2^{14}\) 。只有在两端都支持的系统上该选项才有用。</li>
<li>时间戳选项。对于高速连接这是必要选项，可以防止由失而复得的分组可能造成的数据损坏。类似窗口扩展，这也需要双端支持。</li>
</ul>
<p>大多数实现都支持这些设置，后两项有时称为 <code>RFC 1323 选项</code>，高宽带或长延迟网络被称为 <strong>长胖管道</strong> (long fat pipe)，因此后两项也称为 <code>长胖管道选项</code>。</p>
<h3 id="tcp-连接终止" class="headerLink">
    <a href="#tcp-%e8%bf%9e%e6%8e%a5%e7%bb%88%e6%ad%a2" class="header-mark"></a>TCP 连接终止</h3><p>相比创建连接的三次握手，终止连接往往需要四步：</p>
<ol>
<li>TCP 一端首先发起 <code>close/1</code> ，我们将这一端称为 <strong>主动关闭</strong> (active close)。主动端 TCP 将会发送 <strong>FIN</strong> 字段，这意味着所有数据发送完成。</li>
<li>接收 FIN 的 TCP 端被称为 <strong>被动关闭</strong> (passive close)，接收到 FIN 后将会进行确认。</li>
<li>一段时间之后，被动端将会调用 <code>close/1</code> 来发送 FIN。</li>
<li>最终主动端将确认 FIN 并断开这个连接。</li>
</ol>
<figure><img src="/images/unp-tcp-four-way-termination.svg" width="50%"/>
</figure>

<p>FIN 与 SYN 类似同样占据一个字节，而 ACK 是 FIN 序列号加 1。在第二步与第三步之间，依然可能有数据流动，但这个数据仅有被动关闭端到主动关闭端，这个状态被称为 <strong>半断开状态</strong> (half-close)。</p>
<p>这在里 FIN 的发生是因为调用了 <code>close/1</code> ，不过需要注意当程序主动终止时 (<code>exit/1</code>
或 main return) 还是被动 (接收到终止程序的信号)，所有打开的文件描述符都会被关闭，此时的 TCP sockfd 也不例外，因此这时也会发送 FIN。</p>
<p>最后提一点，主动关闭端是无论 server 还是 client 都可以的，并非只有 client 主动关闭。不过通常情况下都是 client 发起，在 HTTP/1.0 中是个例外。</p>
<h3 id="tcp-状态转换" class="headerLink">
    <a href="#tcp-%e7%8a%b6%e6%80%81%e8%bd%ac%e6%8d%a2" class="header-mark"></a>TCP 状态转换</h3><p>TCP 涉及连接建立和终止的状态可以使用状态转换图来表示。TCP 连接中一共有 11 种不同的状态，并且这些状态之间有详细的转换规则，且转换基于当前状态与接收到的消息。</p>
<figure><img src="/images/unp-tcp-state-transition-diagram.svg" width="75%"/>
</figure>

<p>上图中标记了两个没有介绍过的转换：<strong>同时打开</strong> (simultaneous open) 和 <strong>同时关闭</strong>
(simultaneous close)，它们是两端同时发送 SYN / FIN 的情形下产生的，虽然及其罕见但并不是不能发生。</p>
<h3 id="tcp-的分节" class="headerLink">
    <a href="#tcp-%e7%9a%84%e5%88%86%e8%8a%82" class="header-mark"></a>TCP 的分节</h3><p>在完整的 TCP 连接中，会有建立连接、传输数据、终止连接三个阶段。</p>
<p>在连接建立时，客户端与服务端宣告了不同的 MSS (这不构成任何影响)，连接建立后客户端将请求的数据按 1460 字节进行分组，而服务端回复请求时则采用 536 字节分组。</p>
<p>还需要注意一点，数据传输过程中服务器对请求的 ACK 携带在响应之上一并发送。这种做法称之为 <strong>捎带</strong> (piggybacking)，通常在服务器产生应答时间少于 200 ms 时发生，如果更长时间的耗时则会先发送 ACK 再进行响应。</p>
<p>值得注意的是，如果只是以单分节的请求响应为目的，TCP 连接将会产生 8 个分节的开销，而采用 UDP 仅仅有请求与响应的开销。</p>
<h3 id="time-wait-状态" class="headerLink">
    <a href="#time-wait-%e7%8a%b6%e6%80%81" class="header-mark"></a>TIME_WAIT 状态</h3><p>TCP 连接中，毫无疑问 <code>TIME_WAIT</code> 是最难理解的。这个状态将在主动关闭端经历，该端将在这个状态持续 <strong>最长分节生命期</strong> (maximum segment lifetime, MSL) 的两倍，或者称为 2MSL。</p>
<p>每一个 TCP 实现中都会定义 MSL，RFC 1122 中建议 MSL 为 2 分钟，BSD 实现中一般为
30s，Linux 实现默认为 60s。MSL 是任何 IP 数据报在 Internet 上所能存活的最大时长。当然数据还会包含一个 8 bit 的 <strong>跳限</strong> (hop limit)，即 IPv4 中哦过的 TTL 字段与
IPv6 中的跳限字段，拥有最大跳限的数据依然不能超过 MSL 时间限制。网络中报文丢失通常是路由器出现问题，比如漰溃或两个路由链路断开，路由可能需要几秒甚至几分钟来找到其他稳定的通路。在这期间，路由可能会发生循环 (由 A 发送给 B，然后 B 再发送回 A)，因此在迷途期间，发送端检测到超时将会重发该数据，重传的数据可能从其他路径到达目的地址。而可能在 MSL 之内迷失的数据也被送达目的地，这个分组被称为 <strong>迷失重复</strong> (lost
duplicate) 或 <strong>漫游重复</strong> (wandering duplicate)。</p>
<p>TIME_WAIT 状态有两个存在的理由：</p>
<ol>
<li>
<p>可靠地实现 TCP 全双工终止连接。</p>
<p>最终 ACK 丢失的情况下，主动关闭端必须重传 ACK，而它必须正确处理终止序列丢失的情况。</p>
</li>
<li>
<p>允许旧的重复分节在网络中过期</p>
<p>TCP 需要防止在 TIME_WAIT 期间，如果相同的 IP、port 发送来的新的数据，防止误解属于正在断开的连接的迷失重复。因此 TCP 将给处于 TIME_WAIT 状态的连接发起新的连接，而 2 MSL 可以保证任何方向上的分节都以被丢弃。保证在发起新连接时，老旧连接的数据以全部消逝。</p>
</li>
</ol>
<h2 id="sctp-关联" class="headerLink">
    <a href="#sctp-%e5%85%b3%e8%81%94" class="header-mark"></a>SCTP 关联</h2><p>SCTP 是与 TCP 类似的面向连接协议，关联可以被建立和终止，但与 TCP 相比有些不同。</p>
<figure><img src="/images/unp-sctp-state-transition-diagram.svg" width="75%"/>
</figure>

<h3 id="sctp-创建关联" class="headerLink">
    <a href="#sctp-%e5%88%9b%e5%bb%ba%e5%85%b3%e8%81%94" class="header-mark"></a>SCTP 创建关联</h3><p>SCTP 创建关联需要四次握手。</p>
<ol>
<li>服务端必须准备好接受接入关联，通常与 TCP 类似使用 <code>socket/3</code>, <code>bind/3</code> 和
<code>listen/2</code> 进行被动连接。</li>
<li>客户端通过 <code>connect/3</code> 或发送隐式打开关联消息来进行主动连接。这使得 SCTP 发送一个 INIT 消息来告知服务端，客户端有哪些 IP 地址、初始化序列号、标识该关联中的所有分组的初始标签、客户端请求的外出流数量以及客户端支持的外来流数量。</li>
<li>服务端会使用 <strong>INIT-ACK</strong> 确认客户端 INIT 消息，并包含同样的信息以及状态
cookie。状态 cookie 包含了服务器需要确认关联是否有效的所有状态，cookie 进行数字签名以确保其有效性。</li>
<li>客户端以 COOKIE-ECHO 对服务器状态 cookie 进行响应，在同一分组中还可能直接包含用户数据。</li>
<li>服务端确认 cookie 正确并回复 COOKIE-ACK 建立关联，当然同样可能携带用户数据。</li>
</ol>
<figure><img src="/images/unp-sctp-four-way-handshake.svg" width="50%"/>
</figure>

<p>SCTP 最少需要 4 个分组进行请求，这四次握手与 TCP 的三次握手很相似，除了 cookie
生成部分。INIT 将会携带一个验证标签 Ta 和一个初始化序列号 J。Ta 必须出现在关联中的所有分组中，对端 INIT ACK 中承载一个验证标记 Tz，而 Tz 也需要在关联有效期内出现在每个分组中。另外 STCP 服务端在 INIT-ACK 中提供了 cookie，这个 cookie 包含了设置该关联所需的所有状态，而 SCTP 协议栈无需保存所关联客户的有关信息。</p>
<p>由于 SCTP 支持多宿，在四次握手结束之后两端会各自选择一个主目的地址作为默认地址。</p>
<h3 id="sctp-终止关联" class="headerLink">
    <a href="#sctp-%e7%bb%88%e6%ad%a2%e5%85%b3%e8%81%94" class="header-mark"></a>SCTP 终止关联</h3><p>SCTP 不提供 TCP 那样的半连接状态，当一端停止连接时另一端必须停止发送所有新数据。请求关闭关联的接受端在数据队列中的所有数据发送完之后完成关闭。</p>
<figure><img src="/images/unp-sctp-association-closed.svg" width="50%"/>
</figure>

<p>由于使用验证标签的缘故，因此 SCTP 也不需要 TIME_WAIT 状态，数据首部会包含 INIT
和 INIT-ACK 中所交换的标记，由此区分是否是旧的连接。</p>
<h3 id="sctp-的分节" class="headerLink">
    <a href="#sctp-%e7%9a%84%e5%88%86%e8%8a%82" class="header-mark"></a>SCTP 的分节</h3><p>与 TCP 类似，SCTP 也需要经历建立关联、传输数据、终止关联三个阶段。</p>
<p>客户端发送 COOKIE-ECHO 时可以捎带 DATA，而服务器在 COOKIE-ACK 也可以捎带数据，一般而言当网络应用采用一到多接口样式时将会捎带一个或多个 DATA 块。</p>
<p>SCTP 分组信息的单位称为块 (chunk)，这是一种自述型分组，包含了块类型、若干块标记和块长度。这样做是为了方便进行多个块的绑缚，只需要简单的将多个块合并到一个 SCTP
中即可。</p>
<h3 id="sctp-的选项" class="headerLink">
    <a href="#sctp-%e7%9a%84%e9%80%89%e9%a1%b9" class="header-mark"></a>SCTP 的选项</h3><p>SCTP 使用参数和块方便增设的可选特性，新的特性通过添加这两个条目之一增添，并允许通常的 SCTP 处理规则未知的参数和块。参数类型字段和块类型字段的高 2 bit 指明 SCTP
接收端该如何处理位置的参数或块。</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 04-07</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/2022/unixnetworkprogramming_002/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span><span>|&nbsp;<a class="link-to-report" href=https://gitlab.com/GinShio/ginshio.gitlab.io/issues/new?issue[title]=[BUG]%20%E4%BC%A0%E8%BE%93%E5%B1%82%E6%80%BB%E8%BF%B0&issue[description]=[POST](https://blog.ginshio.org/2022/unixnetworkprogramming_002/)%0A%0A##%20Isseus%0A target="_blank" rel="noopener noreferrer">报告问题</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="分享到 Twitter" data-sharer="twitter" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述" data-hashtags="Note,Unix,Network,Posix"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Facebook" data-sharer="facebook" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-hashtag="Note"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/"><i class="fab fa-linkedin fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述"><i class="fab fa-hacker-news fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Line" data-sharer="line" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" onclick="return false;" title="分享到 Telegram" data-sharer="telegram" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述" data-web><i class="fab fa-telegram-plane fa-fw"></i></a><a href="#" class="weixin" onclick="return false;" title="分享到 微信" data-sharer="weixin" data-url="https://blog.ginshio.org/2022/unixnetworkprogramming_002/" data-title="传输层总述" data-web><i class="fab fa-weixin fa-fw"></i><img src="https://api.oick.cn/qrcode/api.php?size=256&amp;text=https://blog.ginshio.org/2022/unixnetworkprogramming_002/" title="传输层总述">
    </a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/note/">Note</a>,&nbsp;<a href="/tags/unix/">Unix</a>,&nbsp;<a href="/tags/network/">Network</a>,&nbsp;<a href="/tags/posix/">Posix</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/unixnetworkprogramming_001/" class="prev" rel="prev" title="UNP 简介"><i class="fas fa-angle-left fa-fw"></i>UNP 简介</a>
            <a href="/2022/dst_lua_language_study/" class="next" rel="next" title="Lua 语言学习">Lua 语言学习<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.102.3">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://blog.ginshio.org/" target="_blank" rel="noopener noreferrer"> </a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div><script>
                    if('serviceWorker' in navigator) {
                        navigator.serviceWorker
                            .register('/sw.min.js', { scope: '/' })
                            .then(function(registration) {
                            });
                
                        navigator.serviceWorker
                            .ready
                            .then(function(registration) {
                            });
                    }
                </script></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/gitalk/gitalk.min.b250718923eb2b3c2ba2de589fcc7f623ebf3efa17f0e501e7de204156024b108524ffafaf0958fd09d3b68cf0412999.css" integrity="sha384-slBxiSPrKzwrot5Yn8x/Yj6/PvoX8OUB594gQVYCSxCFJP&#43;vrwlY/QnTtozwQSmZ"><link rel="stylesheet" href="/lib/katex/katex.min.bcaaee8fe6b5dd4f321c8900c8680ad49dc0ad32f3ac51816c1734b43a7869dfc4c9ec0449e5c4fc8bfaec08fc80a674.css" integrity="sha384-vKruj&#43;a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.1f5388069d157848068f2228e33a72016ef3233cfb0afc2940343e446a708357e5b391b470f94c0e1c80745c331651ca.css" integrity="sha384-H1OIBp0VeEgGjyIo4zpyAW7zIzz7CvwpQDQ&#43;RGpwg1fls5G0cPlMDhyAdFwzFlHK">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.1f5388069d157848068f2228e33a72016ef3233cfb0afc2940343e446a708357e5b391b470f94c0e1c80745c331651ca.css" integrity="sha384-H1OIBp0VeEgGjyIo4zpyAW7zIzz7CvwpQDQ&#43;RGpwg1fls5G0cPlMDhyAdFwzFlHK"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":12},"comment":{"gitalk":{"admin":["GinShio"],"clientID":"96cbbb15f26bebd9141b","clientSecret":"29c7df99d6e1806113996333163a9476027ff1fa","id":"2022-01-18T19:55:40+08:00","owner":"GinShio","repo":"ginshio.github.io","title":"传输层总述"}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"ABF13CGNA0","algoliaIndex":"ginshio_blog","algoliaSearchKey":"51cf3425aba132c091b477c3d5e06eea","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/gitalk/gitalk.min.1420a0c0459673bc6824e7ba713f1e0ec1540e86491daf1b6149a7af9cd3f396c86b9182d03e4c727faefae17b746033.js" integrity="sha384-FCCgwEWWc7xoJOe6cT8eDsFUDoZJHa8bYUmnr5zT85bIa5GC0D5Mcn&#43;u&#43;uF7dGAz"></script><script type="text/javascript" src="/js/gitalk.min.js" defer></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.dd4cfdb9c1bcaa687c9794e0620c478af43dec711c465b0560c274a0c20d6023bc183b8817015eb778ab746927905d6e.js" integrity="sha384-3Uz9ucG8qmh8l5TgYgxHivQ97HEcRlsFYMJ0oMINYCO8GDuIFwFet3irdGknkF1u"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.cd363f7498fd08d5e75d97ca1f2510d87d073b35592ba69016728082f8e5e9db33b432643010810a6e88152c4f650059.js" integrity="sha384-zTY/dJj9CNXnXZfKHyUQ2H0HOzVZK6aQFnKAgvjl6dsztDJkMBCBCm6IFSxPZQBZ"></script><script type="text/javascript" src="/lib/tablesort/tablesort.min.d120034e53740430f5243f8e25b646e7bdcca97780e02962c37e3adefb264c1b457f8fc397698851f42e32d7168bdd1e.js" integrity="sha384-0SADTlN0BDD1JD&#43;OJbZG573MqXeA4Cliw3463vsmTBtFf4/Dl2mIUfQuMtcWi90e"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.094758c1816ef1698123c876e7b739ac27751905f428bfb349857a93244d636b615bb42a43298a19f4c2235587c33bf2.js" integrity="sha384-CUdYwYFu8WmBI8h257c5rCd1GQX0KL&#43;zSYV6kyRNY2thW7QqQymKGfTCI1WHwzvy"></script><script type="text/javascript" src="/lib/sharer/sharer.min.0097b33812ac4873e9a2e0813de400c9ea9b07e223998d3cbc38a89bdfa3f45cc344689061a836fcd6f4c120eed429b4.js" integrity="sha384-AJezOBKsSHPpouCBPeQAyeqbB&#43;IjmY08vDiom9&#43;j9FzDRGiQYag2/Nb0wSDu1Cm0"></script><script type="text/javascript" src="/lib/katex/katex.min.3f04544ff62a6e71239193b4cd9c4da9cc400ab5defa3efae94d9a997720320e78e7baef7b663b23a6494a6d80d264b8.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe&#43;j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.f95071777afa5e0511c9caad675d7b9d8c38e0e39c21ac79e99e1d09159bc723edd0aa1a875b87a0ad28e3efd1444d39.js" integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.c30ff9f376878715a4cf90c4567e8e2ad36221a2e2da20513595df251898d408bbb6727d517a44b32bce2135694e5e00.js" integrity="sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.453374f1ad005c88a83c1715a2c12a3d47ca2beacfa7e875c7f8b347bc4c91d332bb091c64259dc4ef914b0205b495cd.js" integrity="sha384-RTN08a0AXIioPBcVosEqPUfKK&#43;rPp&#43;h1x/izR7xMkdMyuwkcZCWdxO&#43;RSwIFtJXN" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'G-J5NHMZLLDX', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=G-J5NHMZLLDX" async></script><script>
			var _hmt = _hmt || [];
			(function() {
			  var hm = document.createElement("script");
			  hm.src = "https://hm.baidu.com/hm.js?9370523af547bac6b97e9c3b1461cd16";
			  var s = document.getElementsByTagName("script")[0]; 
			  s.parentNode.insertBefore(hm, s);
			})();
		</script></div>
</body>

</html>